---
title: "Dplyr graded lab"
author: "Louise Cazalet Dance"
format: html
editor: visual
---
### Link to the github repository

https://github.com/cazaletlouise/eval-grades


```{r}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# Necessary packages 
library(readr)
library(dplyr)
library(tidyr)
library(vroom)
library(here)
library (knitr)
library(ggplot2)
library(lubridate)

here::i_am("eval-grades.Rproj")
```


## Introduction

### Study organization 

#### Question 1

```{r}
courses <- vroom(
  here("data", "courses.csv"), show_col_types = FALSE)
```
##### Question 2

```{r}
courses |>
  rename(
  `course name` = course,
  identifier = course_id,
  `number of grades` = nb_grades
) |>
  arrange(`course name`) |>
  kable()
```

### Students

#### Question 3

```{r}
students <- vroom(
  here("data", "students.csv"), show_col_types = FALSE)

students <- students |>
  mutate(
    birth_date = as.Date(birth_date),  
    sex = factor(sex),                
    group = factor(group),             
    id = as.integer(id)               
  )

birth_date_class <- class(students$birth_date)
sex_class <- class(students$sex)


```
The birth_date column of the students data frame is of class `{r} birth_date_class`.

The sex column of the students data frame is of class `{r} sex_class`.

### Grades

#### Question 4

```{r}
grades <- vroom(
  here("data", "grades.csv"),
  delim = "|",   
  na = "_", 
  show_col_types = FALSE
)

```

## Student population

### Question 5

```{r}

students_count <- students |>
  group_by(group) |>
  summarise(n_students = n())

ggplot(students_count, aes(x = group, y = n_students)) +
  geom_col(fill = "orange") +
  labs(
    title = "Number of Students per Group",
    x = "Group",
    y = "Number of Students"
  )
```

### Question 6

```{r}
students |>
  ggplot(aes(x = group, fill = sex)) +
  geom_bar(position = "fill") +  
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Gender Balance per Group",
    x = "Group",
    y = "Proportion of Students",
    fill = "Sex"
  )
```
Gender distribution is balanced between male and female students in each group.


### Question 7

```{r}

students <- students |>
  mutate(
    age = floor(time_length(today() - birth_date, unit = "year"))
  )


students |>
  ggplot(aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "pink") +
  labs(
    title = "Distribution of Student Ages",
    x = "Age (years)",
    y = "Number of Students"
  )

```
The distribution of the age of student is highly concentrated around 21-22 years old.

### Question 8

```{r}
median_age_group <- students |>
  group_by(group) |>
  summarise(median_age = as.integer(median(age)))

median_age_group |>
  kable(
    caption = "Median age of students per group"
  )
```

### Question 9

```{r}
oldest_students <- students |>
  group_by(group) |>
  slice_max(order_by = age) |>
  select(id, sex, age) |>
  arrange(desc(age))


oldest_students |>
  kable(
    caption = "Oldest student in each group"
  )
```

## Simple grade analysis

### Question 10 

```{r}
n_grades <- sum(!is.na(grades$grade))
```

The data set contains `r n_grades` grades.

### Question 11

```{r}

avg_sanskrit <- grades |>
  filter(course_id == courses |>
           filter(course == "Sanskrit Language and Literature") |>
           pull(course_id)) |>
  left_join(students, by = "id") |>
  group_by(group) |>
  summarise(avg_grade = mean(grade, na.rm = TRUE))


avg_sanskrit |>
  ggplot(aes(x = factor(group), y = avg_grade)) +
  geom_col(fill = "lightgreen") +
  labs(
    title = "Average Grade in Sanskrit Language and Literature by Group",
    x = "Group",
    y = "Average Grade"
  ) 

```

The average grade of the course Sanskrit Language and Literature does not seem to depend on the group.

### Question 12

```{r}
grades_semester<- grades |>
  left_join(courses |> select(course_id, semester), by = "course_id") |>
  filter(!is.na(grade))

grades_semester|>
  ggplot(aes(x = grade, fill = factor(semester))) +
  geom_density(alpha=0.5) +
  labs(
    title = "Distribution of grades by semester",
    x = "Grade",
    y = "Density",
    fill = "Semester"
  ) 

```

There seems to be higher grades in semester 1 then semester 2. Also, it seems that in semester 2 the grades were more concentrated around 10.

## Attendance analysis 

### Question 13

```{r}

grades_per_student <- grades |>
  filter(!is.na(grade)) |>
  group_by(id) |>
  summarise(
    n_grades = n(),
    .groups = "drop"
  ) |>
  left_join(students |> select(id, group, sex), by = "id")


grades_per_student |> 
  slice_head(n = 5) |>  
  kable(
    caption = "Number of grades per student",
    align = "c"
  )



Minimum <- min(grades_per_student$n_grades)
Maximum <- max(grades_per_student$n_grades)
mean_grades <- round(mean(grades_per_student$n_grades), 2)
median_grades <- median(grades_per_student$n_grades)



```
| Statistic | Value |
|-----------|-------|
| Minimum   | `r Minimum` |
| Maximum   | `r Maximum` |
| Average   | `r mean_grades` |
| Median    | `r median_grades` |


### Question 14


```{r}
grades_per_student |>
  ggplot(aes(x = n_grades, fill = sex)) +
  geom_density(alpha = 0.4) +       
  labs(
    title = "Distribution of number of grades by sex",
    x = "Number of grades",
    y = "Density",
    fill = "Sex"
  ) 
```
The distribution of the number of grades does not seem to depend on the sex. 


### Question 15

```{r}
yoga_grades <- grades |>
  filter(!is.na(grade)) |>
  inner_join(courses, by = "course_id") |>
  filter(course == "Yoga and Meditation") |>
  group_by(id) |>
  summarise(n_yoga_grades = n(), .groups = "drop") |>
  left_join(students |> select(id, group), by = "id")


yoga_grades |> 
  slice_head(n = 5) |>
  kable(
    caption = "Number of Yoga and Meditation grades per student",
    align = "c"
  )


```

### Question 16

```{r}
yoga_grades |>
  count(n_yoga_grades) |>
  ggplot(aes(x = n_yoga_grades, y = n)) +
  geom_col(fill = "lightblue") +
  labs(
    title = "Distribution of number of yoga and meditation grades",
    x = "Number of Grades",
    y = "Number of Students"
  )
```

# Question 17

```{r}
yoga_grades |>
  ggplot(aes(x = factor(group), y = n_yoga_grades)) +
  geom_boxplot(fill = "lightpink", alpha = 0.6) + 
  labs(
    title = "Number of Yoga and Meditation Grades per Student by Group",
    x = "Group",
    y = "Number of Grades"
  ) 

```

The number of grades per student does not seem to depend on the group.

### Question 18 

```{r}
yoga_grades <- yoga_grades |>
  left_join(students |> select(id, sex), by = "id")

yoga_grades |>
  ggplot(aes(x = factor(group), y = n_yoga_grades, fill = sex)) +
  geom_boxplot(alpha = 0.6, position = position_dodge(width = 0.8)) +
  labs(
    title = "Number of Yoga and Meditation grades by group and sex",
    x = "Group",
    y = "Number of Grades",
    fill = "Sex"
  )
```
The sex does not seem to have an impact on the number of Yoga and Meditation grades by group.

## Grade analysis

### Question 19

```{r}

grades_avg <- grades |>
  filter(!is.na(grade)) |>
  group_by(id, course_id) |>
  summarise(avg_grade = mean(grade), .groups = "drop") |>
  left_join(students |> select(id, group), by = "id") |>
  left_join(courses |> select(course_id, course), by = "course_id")


grades_wide <- grades_avg |>
  select(id, group, course, avg_grade) |>
  pivot_wider(
    names_from = course,
    values_from = avg_grade
  )


grades_wide |>
  select(id, group, `Yoga and Meditation`, `Sanskrit Language and Literature`) |>
  slice_head(n = 5) |>
  kable(
    caption = "Extract of Average Grades per Student for Selected Courses",
    align = "c"
  )

```

### Question 20

```{r}
grades_wide |>
  ggplot(aes(
    x = `Yoga and Meditation`,
    y = `Martial Arts and Self-Defense`
  )) +
  geom_point(alpha = 1, color = "darkgreen", size = 1) +  
  geom_smooth(method = "lm", color = "sienna") 
  labs(
    title = "Average Grades: Martial Arts vs Yoga and Meditation",
    x = "Average Grade in Yoga and Meditation",
    y = "Average Grade in Martial Arts and Self-Defense"
  )
```
There seem to be a positive relation between the Average Grade in Yoga and Meditation and the Average Grade in Martial Arts and Self-Defense.


### Question 21

```{r}
cor_by_group <- grades_wide |>
  group_by(group) |>
  summarise(
    cor_pol_music = cor(`Politics and Diplomacy`, `Music and Dance`, use = "complete.obs"),
    .groups = "drop"
  )
```

### Question 22

```{r}
target_group <- cor_by_group |>
  slice_max(order_by = abs(cor_pol_music), n = 1) |>
  pull(group)

grades_wide |>
  filter(group == target_group) |>
  ggplot(aes(
    x = `Music and Dance`,
    y = `Politics and Diplomacy`
  )) +
  geom_point(alpha = 0.7, color = "blue", size = 3) +
  geom_smooth(method = "lm", color = "red") +
  labs(
    title = "Politics and Diplomacy vs Music and Dance",
    x = "Average Grade in Music and Dance",
    y = "Average Grade in Politics and Diplomacy"
  )
```

### Question 23

```{r}

final_grades <- grades_wide |>
  left_join(students |> select(id, sex), by = "id") |> 
  rowwise() |>
  mutate(
    final_grade = mean(c_across(where(is.numeric) & !c(id, group)), na.rm = TRUE)
  ) |>
  ungroup() |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))


final_grades |>
  slice_head(n = 5) |>
  kable(
    caption = "Top 5 students by final grade",
    digits = 2,
    align = "c"
  )

```

### Question 24

```{r}
final_grades |>
  ggplot(aes(x = factor(group), y = final_grade)) +
  geom_boxplot(fill = "violet", alpha = 0.6) +
  labs(
    x = "Group",
    y = "Final Grade",
    title = "Distribution of Final Grades by Group"
  ) 

```
The distribution of final grades varies across groups. In particular, groups 1 and 14 appear to have higher/lower grades compared to groups such as 3 and 15

### Question 25

```{r}
final_grades |>
  ggplot(aes(x = factor(group), y = final_grade, fill = sex)) +
  geom_boxplot(alpha = 0.6, position = position_dodge(width = 0.8)) +
  labs(
    x = "Group",
    y = "Final Grade",
    fill = "Sex",
    title = "Distribution of Final Grades by Group and Sex"
  )

```

We can see a slight difference between the grades of women and men within the same group. Some groups, like group 1 and group 10, show a wider distribution of grades for men. 

### Question 26

```{r}

grades_avg_sem <- grades_avg |>
  left_join(courses |> select(course, semester), by = "course")

students_pass <- grades_avg_sem |>
  group_by(id, group) |>
  summarise(
    final_grade = mean(avg_grade, na.rm = TRUE),
    pass_courses = all(avg_grade >= 5),
    semester1_avg = mean(avg_grade[semester == 1], na.rm = TRUE),
    semester2_avg = mean(avg_grade[semester == 2], na.rm = TRUE),
    pass = pass_courses & semester1_avg >= 10 & semester2_avg >= 10,
    .groups = "drop"
  )

students_pass |>
  slice_head(n = 5) |>
  knitr::kable(
    caption = "First five students with final grade and pass/fail",
    align = "c"
  )

```


### Question 27

```{r}
students_fail_high <- students_pass |>
  filter(!pass & final_grade >= 10)
n_fail_high <- nrow(students_fail_high)
cat("The number of students who do not pass but have a final grade >= 10 is:", n_fail_high, "\n")


```

### Question 28 
```{r}
pass_rate_by_group <- students_pass |>
  group_by(group) |>
  summarise(
    pass_rate = mean(pass) * 100,
    .groups = "drop"
  )


ggplot(pass_rate_by_group, aes(x = factor(group), y = pass_rate)) +
  geom_col(fill = "red") +
  labs(
    x = "Group",
    y = "Pass rate (%)",
    title = "Pass rate per group"
  )
```
On this graph, we can see that the pass rate highly varies between the groups.

### Question 29
```{r}
fail_course_counts <- grades_avg |>
  filter(avg_grade < 5) |>
  group_by(course) |>
  summarise(
    n_failures = n(),
    .groups = "drop"
  ) |>
  arrange(desc(n_failures))

most_fail_course <- fail_course_counts |> slice_head(n = 1)
most_fail_course


```
### Question 30

```{r}

students_with_pass <- students |>
  left_join(students_pass |> select(id, pass), by = "id")
success_by_age <- students_with_pass |>
  group_by(age) |>
  summarise(success_rate = mean(pass), .groups = "drop")

ggplot(success_by_age, aes(x = age, y = success_rate)) +
  geom_col(fill = "steelblue") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    x = "Age",
    y = "Success rate",
    title = "Success rate as a function of student age"
  ) 

```
The success rate varies more noticeably across age groups rather than individual ages. For example, students in the 20â€“29 age range show around a 60% success rate, while students aged 30 and above almost always have a 100% success rate.

